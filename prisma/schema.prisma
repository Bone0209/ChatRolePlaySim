// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["views"]
}

datasource db {
  provider = "sqlite"
}

// --- Master Data (Definitions & Invariants) ---

model MWorld {
  id        String   @id
  name      String
  prompt    String
  createdAt DateTime @default(now()) @map("created_at")

  entities MEntity[]
  chats    TChat[]
  apiLogs  TApiLog[]

  // New Relations
  locations      MLocation[]
  attributeMetas MAttributeMeta[]

  @@map("m_worlds")
}

model MGlobalConstant {
  id        Int      @id @default(autoincrement())
  category  String
  keyName   String   @unique @map("key_name")
  keyValue  String   @map("key_value")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("m_global_constants")
}

model MEntity {
  id          String   @id @default(uuid())
  worldId     String   @map("world_id")
  type        String
  name        String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  world MWorld  @relation(fields: [worldId], references: [id], onDelete: Cascade)
  chats TChat[]

  // Relations to Category Data
  initialPersona MEntityPersona?
  currentPersona TEntityPersona?
  historyPersona HEntityPersona[]

  initialParameter MEntityParameter?
  currentParameter TEntityParameter?
  historyParameter HEntityParameter[]

  initialState MEntityState?
  currentState TEntityState?
  historyState HEntityState[]

  // Integrated Attributes Relations
  initialAttributes MEntityAttribute[]
  currentAttributes TEntityAttribute[]
  historyAttributes HEntityAttribute[]

  apiLogs TApiLog[]

  @@map("m_entities")
}

// --- Category: Persona (Personality) ---

model MEntityPersona {
  id        Int      @id @default(autoincrement())
  entityId  String   @unique @map("entity_id")
  data      Json // Initial KV data
  createdAt DateTime @default(now()) @map("created_at")

  entity MEntity @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@map("m_entity_personas")
}

model TEntityPersona {
  id        Int      @id @default(autoincrement())
  entityId  String   @unique @map("entity_id")
  data      Json // Current KV data
  updatedAt DateTime @updatedAt @map("updated_at")

  entity MEntity @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@map("t_entity_personas")
}

model HEntityPersona {
  id        Int      @id @default(autoincrement())
  entityId  String   @map("entity_id")
  diff      Json // Diff data { add, del, upd }
  createdAt DateTime @default(now()) @map("created_at")

  entity MEntity @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@map("h_entity_personas")
}

// --- Category: Parameter (Stats like HP, MP) ---

model MEntityParameter {
  id        Int      @id @default(autoincrement())
  entityId  String   @unique @map("entity_id")
  data      Json
  createdAt DateTime @default(now()) @map("created_at")

  entity MEntity @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@map("m_entity_parameters")
}

model TEntityParameter {
  id        Int      @id @default(autoincrement())
  entityId  String   @unique @map("entity_id")
  data      Json
  updatedAt DateTime @updatedAt @map("updated_at")

  entity MEntity @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@map("t_entity_parameters")
}

model HEntityParameter {
  id        Int      @id @default(autoincrement())
  entityId  String   @map("entity_id")
  diff      Json
  createdAt DateTime @default(now()) @map("created_at")

  entity MEntity @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@map("h_entity_parameters")
}

// --- Category: State (Location, Condition) ---

model MEntityState {
  id        Int      @id @default(autoincrement())
  entityId  String   @unique @map("entity_id")
  data      Json
  createdAt DateTime @default(now()) @map("created_at")

  entity MEntity @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@map("m_entity_states")
}

model TEntityState {
  id        Int      @id @default(autoincrement())
  entityId  String   @unique @map("entity_id")
  data      Json
  updatedAt DateTime @updatedAt @map("updated_at")

  entity MEntity @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@map("t_entity_states")
}

model HEntityState {
  id        Int      @id @default(autoincrement())
  entityId  String   @map("entity_id")
  diff      Json
  createdAt DateTime @default(now()) @map("created_at")

  entity MEntity @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@map("h_entity_states")
}

// --- Transaction Data (Logs) ---

model TChat {
  id        Int      @id @default(autoincrement())
  worldId   String   @map("world_id")
  chatType  String   @map("chat_type")
  message   String
  createdAt DateTime @default(now()) @map("created_at")
  entityId  String?  @map("entity_id")
  isVisible Boolean  @default(true) @map("is_visible")

  world  MWorld   @relation(fields: [worldId], references: [id], onDelete: Cascade)
  entity MEntity? @relation(fields: [entityId], references: [id], onDelete: SetNull)

  @@map("t_chats")
}

model TApiLog {
  id              Int      @id @default(autoincrement())
  apiType         String   @map("api_type")
  modelName       String   @map("model_name")
  request         String
  response        String
  statusCode      Int?     @map("status_code")
  errorMessage    String?  @map("error_message")
  executionTimeMs Int?     @map("execution_time_ms")
  worldId         String?  @map("world_id")
  entityId        String?  @map("entity_id")
  createdAt       DateTime @default(now()) @map("created_at")

  world  MWorld?  @relation(fields: [worldId], references: [id], onDelete: SetNull)
  entity MEntity? @relation(fields: [entityId], references: [id], onDelete: SetNull)

  @@index([apiType, createdAt])
  @@index([worldId, createdAt])
  @@index([entityId, createdAt])
  @@index([statusCode])
  @@map("t_api_logs")
}

// --- User Profile & Settings ---

model TUserProfileList {
  id          Int      @id @default(autoincrement())
  profileName String   @map("profile_name")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  profiles TUserProfile[]

  @@map("t_user_profile_lists")
}

model TUserProfile {
  listId    Int    @map("list_id")
  keyName   String @map("key_name")
  keyValue  String @map("key_value")
  valueType String @map("value_type") // 'string', 'number', 'boolean'

  profileList TUserProfileList @relation(fields: [listId], references: [id], onDelete: Cascade)

  @@id([listId, keyName])
  @@map("t_user_profiles")
}

model TUserSetting {
  keyName   String @id @map("key_name")
  keyValue  String @map("key_value")
  valueType String @map("value_type") // 'string', 'number', 'boolean'

  @@map("t_user_settings")
}

// --- New Entity Attribute System (Key-Value) ---

model MAttributeDefinition {
  keyName     String  @id @map("key_name")
  category    String // m_global_constants.attribute_category
  valueType   String  @map("value_type") // m_global_constants.value_type
  description String?

  metas  MAttributeMeta[]
  values TEntityAttribute[] // Relation for consistency check if needed

  @@map("m_attribute_definitions")
}

model MAttributeMeta {
  id      Int     @id @default(autoincrement())
  worldId String? @map("world_id")
  keyName String  @map("key_name")

  displayName  String @map("display_name")
  displayOrder Int    @default(0) @map("display_order")

  rangeMin Float? @map("range_min")
  rangeMax Float? @map("range_max")

  visibility      String  @default("public")
  visibilityParam String? @map("visibility_param")

  metadata Json?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  definition MAttributeDefinition @relation(fields: [keyName], references: [keyName], onDelete: Cascade)
  world      MWorld?              @relation(fields: [worldId], references: [id], onDelete: Cascade)

  @@unique([worldId, keyName])
  @@map("m_attribute_metas")
}

model MEntityAttribute {
  id        Int      @id @default(autoincrement())
  entityId  String   @map("entity_id")
  keyName   String   @map("key_name")
  keyValue  String   @map("key_value")
  createdAt DateTime @default(now()) @map("created_at")

  entity MEntity @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@unique([entityId, keyName])
  @@map("m_entity_attributes")
}

model TEntityAttribute {
  id        Int      @id @default(autoincrement())
  entityId  String   @map("entity_id")
  keyName   String   @map("key_name")
  keyValue  String   @map("key_value")
  updatedAt DateTime @updatedAt @map("updated_at")

  entity     MEntity              @relation(fields: [entityId], references: [id], onDelete: Cascade)
  definition MAttributeDefinition @relation(fields: [keyName], references: [keyName], onDelete: Cascade)

  @@unique([entityId, keyName])
  @@map("t_entity_attributes")
}

model HEntityAttribute {
  id         Int      @id @default(autoincrement())
  entityId   String   @map("entity_id")
  keyName    String   @map("key_name")
  oldValue   String?  @map("old_value")
  newValue   String?  @map("new_value")
  changeType String   @map("change_type") // 'update', 'create', 'delete'
  createdAt  DateTime @default(now()) @map("created_at")

  entity MEntity @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@map("h_entity_attributes")
}

// --- Location System ---

model MLocation {
  id        String   @id @default(uuid())
  worldId   String   @map("world_id")
  createdAt DateTime @default(now()) @map("created_at")

  world MWorld @relation(fields: [worldId], references: [id], onDelete: Cascade)

  current TLocation?
  history HLocation[]

  attributes       TLocationAttribute[]
  attributeHistory HLocationAttribute[]

  @@map("m_locations")
}

model TLocation {
  id          Int      @id @default(autoincrement())
  locationId  String   @unique @map("location_id")
  name        String
  description String?
  updatedAt   DateTime @updatedAt @map("updated_at")

  location MLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@map("t_locations")
}

model HLocation {
  id          Int      @id @default(autoincrement())
  locationId  String   @map("location_id")
  name        String
  description String?
  changeType  String   @map("change_type")
  createdAt   DateTime @default(now()) @map("created_at")

  location MLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@map("h_locations")
}

model TLocationAttribute {
  id         Int      @id @default(autoincrement())
  locationId String   @map("location_id")
  keyName    String   @map("key_name")
  keyValue   String   @map("key_value")
  updatedAt  DateTime @updatedAt @map("updated_at")

  location MLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([locationId, keyName])
  @@map("t_location_attributes")
}

model HLocationAttribute {
  id         Int      @id @default(autoincrement())
  locationId String   @map("location_id")
  keyName    String   @map("key_name")
  oldValue   String?  @map("old_value")
  newValue   String?  @map("new_value")
  changeType String   @map("change_type")
  createdAt  DateTime @default(now()) @map("created_at")

  location MLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@map("h_location_attributes")
}

// --- Views ---

view VEntityAttributeDetail {
  entityId String @map("entity_id")
  keyName  String @map("key_name")
  keyValue String @map("key_value")
  worldId  String @map("world_id")

  // From Definition
  category  String
  valueType String @map("value_type")

  // From Meta (Resolved)
  displayName     String  @map("display_name")
  displayOrder    Int     @map("display_order")
  rangeMin        Float?  @map("range_min")
  rangeMax        Float?  @map("range_max")
  visibility      String
  visibilityParam String? @map("visibility_param")

  updatedAt DateTime @map("updated_at")

  @@unique([entityId, keyName])
  @@map("v_entity_attribute_details")
}
