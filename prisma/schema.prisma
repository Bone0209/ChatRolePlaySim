
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

// --- Master Data (Definitions & Invariants) ---

model MWorld {
  id        String   @id
  name      String
  prompt    String
  createdAt DateTime @default(now()) @map("created_at")

  entities  MEntity[]
  chats     TChat[]
  apiLogs   TApiLog[]

  @@map("m_worlds")
}

model MGlobalConstant {
  id        Int      @id @default(autoincrement())
  category  String
  keyName   String   @unique @map("key_name")
  keyValue  String   @map("key_value")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("m_global_constants")
}

model MEntity {
  id          String   @id @default(uuid())
  worldId     String   @map("world_id")
  type        String
  name        String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  world       MWorld   @relation(fields: [worldId], references: [id], onDelete: Cascade)
  chats       TChat[]

  // Relations to Category Data
  initialPersona   MEntityPersona?
  currentPersona   TEntityPersona?
  historyPersona   HEntityPersona[]

  initialParameter MEntityParameter?
  currentParameter TEntityParameter?
  historyParameter HEntityParameter[]

  initialState     MEntityState?
  currentState     TEntityState?
  historyState     HEntityState[]

  apiLogs          TApiLog[]

  @@map("m_entities")
}

// --- Category: Persona (Personality) ---

model MEntityPersona {
  id        Int      @id @default(autoincrement())
  entityId  String   @unique @map("entity_id")
  data      Json     // Initial KV data
  createdAt DateTime @default(now()) @map("created_at")

  entity    MEntity  @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@map("m_entity_personas")
}

model TEntityPersona {
  id        Int      @id @default(autoincrement())
  entityId  String   @unique @map("entity_id")
  data      Json     // Current KV data
  updatedAt DateTime @updatedAt @map("updated_at")

  entity    MEntity  @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@map("t_entity_personas")
}

model HEntityPersona {
  id        Int      @id @default(autoincrement())
  entityId  String   @map("entity_id")
  diff      Json     // Diff data { add, del, upd }
  createdAt DateTime @default(now()) @map("created_at")

  entity    MEntity  @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@map("h_entity_personas")
}

// --- Category: Parameter (Stats like HP, MP) ---

model MEntityParameter {
  id        Int      @id @default(autoincrement())
  entityId  String   @unique @map("entity_id")
  data      Json
  createdAt DateTime @default(now()) @map("created_at")

  entity    MEntity  @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@map("m_entity_parameters")
}

model TEntityParameter {
  id        Int      @id @default(autoincrement())
  entityId  String   @unique @map("entity_id")
  data      Json
  updatedAt DateTime @updatedAt @map("updated_at")

  entity    MEntity  @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@map("t_entity_parameters")
}

model HEntityParameter {
  id        Int      @id @default(autoincrement())
  entityId  String   @map("entity_id")
  diff      Json
  createdAt DateTime @default(now()) @map("created_at")

  entity    MEntity  @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@map("h_entity_parameters")
}

// --- Category: State (Location, Condition) ---

model MEntityState {
  id        Int      @id @default(autoincrement())
  entityId  String   @unique @map("entity_id")
  data      Json
  createdAt DateTime @default(now()) @map("created_at")

  entity    MEntity  @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@map("m_entity_states")
}

model TEntityState {
  id        Int      @id @default(autoincrement())
  entityId  String   @unique @map("entity_id")
  data      Json
  updatedAt DateTime @updatedAt @map("updated_at")

  entity    MEntity  @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@map("t_entity_states")
}

model HEntityState {
  id        Int      @id @default(autoincrement())
  entityId  String   @map("entity_id")
  diff      Json
  createdAt DateTime @default(now()) @map("created_at")

  entity    MEntity  @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@map("h_entity_states")
}

// --- Transaction Data (Logs) ---

model TChat {
  id        Int      @id @default(autoincrement())
  worldId   String   @map("world_id")
  chatType  String   @map("chat_type")
  message   String
  createdAt DateTime @default(now()) @map("created_at")
  entityId  String?  @map("entity_id")

  world     MWorld   @relation(fields: [worldId], references: [id], onDelete: Cascade)
  entity    MEntity? @relation(fields: [entityId], references: [id], onDelete: SetNull)

  @@map("t_chats")
}

model TApiLog {
  id              Int      @id @default(autoincrement())
  apiType         String   @map("api_type")
  modelName       String   @map("model_name")
  request         String
  response        String
  statusCode      Int?     @map("status_code")
  errorMessage    String?  @map("error_message")
  executionTimeMs Int?     @map("execution_time_ms")
  worldId         String?  @map("world_id")
  entityId        String?  @map("entity_id")
  createdAt       DateTime @default(now()) @map("created_at")

  world   MWorld?  @relation(fields: [worldId], references: [id], onDelete: SetNull)
  entity  MEntity? @relation(fields: [entityId], references: [id], onDelete: SetNull)

  @@index([apiType, createdAt])
  @@index([worldId, createdAt])
  @@index([entityId, createdAt])
  @@index([statusCode])
  @@map("t_api_logs")
}

// --- User Profile & Settings ---

model TUserProfileList {
  id          Int      @id @default(autoincrement())
  profileName String   @map("profile_name")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  profiles    TUserProfile[]

  @@map("t_user_profile_lists")
}

model TUserProfile {
  listId    Int    @map("list_id")
  keyName   String @map("key_name")
  keyValue  String @map("key_value")
  valueType String @map("value_type") // 'string', 'number', 'boolean'

  profileList TUserProfileList @relation(fields: [listId], references: [id], onDelete: Cascade)

  @@id([listId, keyName])
  @@map("t_user_profiles")
}

model TUserSetting {
  keyName   String @id @map("key_name")
  keyValue  String @map("key_value")
  valueType String @map("value_type") // 'string', 'number', 'boolean'

  @@map("t_user_settings")
}
