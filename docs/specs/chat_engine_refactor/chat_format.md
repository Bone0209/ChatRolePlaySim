# チャットフォーマット仕様書 (v1.0)

本ドキュメントは、チャットエンジンにおけるリクエスト（入力）およびレスポンス（出力）のデータ形式を定義します。

## 設計方針
- **AI最適化:** LLMが理解しやすいXMLライクなタグ構造を採用。
- **トークン削減:** 短縮タグ名を使用し、属性を廃止。
- **拡張性:** メッセージだけでなく、イベントやシステムログも同一配列内で処理可能にする。

---

## 1. レスポンスフォーマット (AI Output)

AIからの出力はJSON形式とし、ルートの `chats` 配列にメッセージオブジェクトを格納します。

### JSON構造
```json
{
  "chats": [
    {
      "type": "C",
      "order": 1,
      "body": "<emo>joy</emo>\n<act>jump</act>\n<msg>わあ、本当ですか！</msg>"
    },
    {
      "type": "I",
      "order": 2,
      "body": "好感度が上がった音がした。"
    }
  ]
}
```

### フィールド定義

| フィールド | 型 | 説明 |
| :--- | :--- | :--- |
| `type` | String | メッセージ種別 (後述) |
| `order` | Integer | 表示順序 (1から開始) |
| `body` | String | 表示内容（タグを含む文字列） |

### Type定義
| 値 | 名称 | 説明 |
| :--- | :--- | :--- |
| `"C"` | Chat | キャラクターの会話。タグ解析対象。 |
| `"I"` | Information | システムログ、情報表示。 |
| `"E"` | Event | イベント発生通知。 |

### Bodyタグ定義 (Type="C"の場合)
属性(`attr="..."`)は使用せず、すべてタグの中身として記述します。
**タグ間には必ず改行 `\n` を含めること。**

| タグ | 名称 | 説明 | 例 |
| :--- | :--- | :--- | :--- |
| `<emo>` | Emotion | 感情キー。立ち絵指定用。 | `<emo>joy</emo>` |
| `<act>` | Action | キャラクターの動作。 | `<act>nod</act>` |
| `<msg>` | Message | 発言内容。 | `<msg>こんにちは</msg>` |

---

## 2. リクエストフォーマット (AI Input)

AIへの入力も、レスポンスと対称性を持たせたXML構造を採用します。これによりFew-shot効果を高めます。

### 入力プロンプト例
ユーザーの入力やシステム状態を以下のXMLに整形してプロンプトに挿入します。

```xml
<user_chats>
  <chat type="C">
    <emo>angry</emo>
    <act>glare</act>
    <msg>なんでそんなことをしたの？</msg>
  </chat>
</user_chats>
```

### 変換ロジック (ショートカット記法)
ユーザー入力時の簡易記法を定義し、システム側でXMLタグに変換します。

| 記法 | 変換先タグ | 例 |
| :--- | :--- | :--- |
| `(text)` | `<emo>text</emo>` | `(angry)` -> `<emo>angry</emo>` |
| `<text>` | `<act>text</act>` | `<nod>` -> `<act>nod</act>` |
| その他 | `<msg>text</msg>` | `なんで？` -> `<msg>なんで？</msg>` |

**変換例:**
- ユーザー入力: `(微笑みながら)おはようございます<汗を拭う>`
- システム変換後: `<emo>微笑みながら</emo><msg>おはようございます</msg><act>汗を拭う</act>`

---

## 4. UI表示ガイドライン
フロントエンドでの表示（レンダリング）に関する推奨スタイル定義です。
テキストとして読む際の没入感を高めつつ、システム的な情報（感情キーなど）を適切に処理します。

### タグごとのスタイル定義

| タグ | 役割 | 推奨スタイル (CSSイメージ) | 表示例 |
| :--- | :--- | :--- | :--- |
| `<emo>` | 感情・状態 | `color: #888; font-style: italic; font-size: 0.9em;` | *微笑みながら* |
| `<act>` | 動作・演技 | `color: #556; font-weight: bold; font-style: italic;` | ***汗を拭う*** |
| `<msg>` | 会話本文 | `color: inherit;` (通常) | おはようございます |

### 表示ロジックの分岐

**1. `<emo>` タグの特別処理:**
`<emo>`の中身が「定義済みの感情キー（joy, angry等）」か「自由記述（微笑みながら等）」かで処理を分けることを推奨します。

- **Case A: 定義済みキー (`joy` 等)**
  - **表示:** テキストとしては**非表示**にする。
  - **機能:** 立ち絵（スプライト）の差分変更トリガーとしてのみ使用する。
  
- **Case B: 自由記述 (`微笑みながら` 等)**
  - **表示:** そのままスタイルを適用して**表示する**。
  - **例:** `微笑みながら` というグレーのテキストを先頭に付与。

**2. `<act>` タグの演出:**
動作を描写するため、会話文とは明確に区別できるよう**Markdownの引用表示（Blockquote）**風にするか、**太字斜体**で強調するとリズムが生まれます。

### MD/HTML変換イメージ
```html
<div class="chat-bubble">
  <!-- emoが自由記述の場合 -->
  <span class="emo-text">微笑みながら</span>
  
  <!-- msg -->
  <span class="msg-text">おはようございます</span>
  
  <br/>
  
  <!-- act -->
  <span class="act-text"> 汗を拭う </span>
</div>
```

1. **エスケープ処理**: JSON文字列内のダブルクォートは `\"`、改行は `\n` にエスケープする必要があります。
2. **パース処理**: `body` の解析は正規表現で行うことを推奨します。属性を持たないため、簡易なRegexで抽出可能です。
   - Tag Pattern: `<(emo|act|msg)>(.*?)</\1>`
