# チャットフォーマット仕様書 (Stream Parser版) v1.2

本ドキュメントでは、LLMからのストリーミングレスポンスをリアルタイムに制御・表示するためのチャットフォーマットを定義します。

## パース仕様 (Parsing Rules)

**「`[` から始まり、次の `[` が来るまでを1つのブロックとする」** ルールを採用します。
改行の有無に関わらず、タグの直後から次のタグまでがそのブロックの内容となります。

- **1行で書く場合:** `[narrative]扉が開く。[speech:門番]止まれ！`
- **改行する場合:**
  ```text
  [narrative]
  扉が開く。
  [speech:門番]
  止まれ！
  ```

どちらも有効です。

---

## ブロック定義

### 1. ナレーション (Narrative)
情景描写や地の文。

**構文:** `[narrative]`

**例:**
```text
[narrative]静かな森の中。鳥の声が聞こえる。
```

### 2. 会話 (Speech)
キャラクターの発言。

**構文:** `[speech:名前]`

**例:**
```text
[speech:アリア]こんにちは！[speech:Player]やあ、元気？
```

### 3. イベント (Event)
イベント生成用LLMへのプロンプト指示、またはシステムへのシグナル。
ここには具体的な処理コードではなく、後続の処理系（イベントハンドラや別のLLM）に対する自然言語またはコマンド形式の指示が入ります。

**構文:** `[event]`

**例:**
```text
[event]BGMを停止して、緊迫した雰囲気に切り替える
```

### 4. システムログ (Log)
内部ログ。

**構文:** `[log]`

**例:**
```text
[log]好感度が更新されました。
```

---

## ストリームデータ例 (Sample Stream)

```text
[narrative]扉がゆっくりと開く。[speech:門番]止まれ。ここから先は通さんぞ。[speech:Player]どうしても通りたいんだ。[log]交渉判定: 失敗[event]battle:start
```
