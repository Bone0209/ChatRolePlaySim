# 機能追加: XMLタグベースのチャットシステムとUI刷新 (2026-01-15)

## 概要
本アップデートでは、LLMの応答品質とUI表現力を向上させるため、チャットシステムを従来のプレーンテキストベースから**独自のXML風タグ形式**（`<msg>`, `<act>`, `<scene>`）へと抜本的に移行しました。
これにより、会話、行動描写、情景描写を明確に構造化し、それを「ビジュアルノベル風」の没入感あるUIで表示することが可能になりました。

## 実装プロセスの詳細

### 1. XMLタグフォーマットの導入 (基盤設計)
- **構造化データの採用**:
    - 従来のテキスト羅列から、以下のタグを用いた構造化フォーマットへ移行しました。
        - `<msg>`: キャラクターの会話文（発話内容）
        - `<act>`: キャラクターの微細な行動や表情の描写
        - `<scene>`: 情景、環境、雰囲気の描写
    - ※ 開発初期に検討された `<emo>`（感情タグ）は、UIのシンプルさと没入感を優先して最終的に廃止・統合されました。

- **プロンプトエンジニアリングの刷新 (`user_prompt.md`)**:
    - LLMに対し、上記のタグ形式で厳密に出力するように指示を追加しました。
    - システムプロンプトを調整し、会話と描写を明確に分離して出力させることで、後段のパース処理を確実にしました。

### 2. メッセージ解析とレンダリング (フロントエンド)
- **パーサーの実装 (`ParsedMessage.tsx`)**:
    - LLMから返却されたタグ付きテキストを解析し、適切なReactコンポーネントに変換する専用コンポーネントを新規実装しました。
    - 正規表現による堅牢なパース処理により、タグの欠損や不正なフォーマットにもある程度対応できる設計としました。
    - **クリーンノベルスタイル (Clean Novel Style)** の適用:
        - 試行錯誤の結果、タグごとの過剰な装飾（枠線や背景）を排除。
        - タイポグラフィ（文字色、イタリック体）のみで情報を区別するスタイルを採用し、「読む体験」を阻害しないUIを実現しました。
        - 厳密な空白除去処理により、テキストの開始位置をピクセル単位で左揃えにしました。

### 3. UI/UXの統合と改善 (`chat.tsx`)
- **ワールド情報の動的表示**:
    - ヘッダータイトルを固定のアプリ名から、現在プレイ中の「ワールド名」に変更。IPC通信（`world:get`）を通じて動的に取得・表示する仕組みを構築しました。
- **インタラクションの強化**:
    - 名前バッジをクリックすることで、そのキャラクターの詳細ステータス画面へ遷移する機能を実装しました。
- **メッセージ表示の最適化**:
    - バックエンド側で同一話者の連続メッセージを結合するロジックを導入し、チャット画面の断片化を防ぎました。

### 4. インフラストラクチャ
- **IPC APIの拡張**:
    - フロントエンドからワールド詳細情報を取得するための `world:get` および `window.electron.worldGet` を追加しました。

## 技術仕様
- **ブランチ**: `feature/chat-upgrade`
- **主要な変更ファイル**:
    - `main/prompts/user_prompt.md` (プロンプト定義)
    - `renderer/components/ParsedMessage.tsx` (パーサー)
    - `renderer/pages/chat.tsx` (メインUI)
    - `main/application/usecases/chat/SendMessageUseCase.ts` (結合ロジック)

## 検証結果
- LLMが指定されたXMLタグ形式で応答することを確認。
- `<act>`や`<scene>`が意図した通りのスタイル（イタリック、色付き）で描画されることを確認。
- ヘッダーのワールド名表示、ステータス画面への遷移が正常に動作することを確認。
