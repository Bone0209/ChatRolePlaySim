# 好感度システム仕様書

## 概要
本ドキュメントは、キャラクターの好感度（Affection）に関する仕様を定義するものです。

## 好感度（Affection）の基本仕様

### 上限値
- **最大値**: 1000（設定により変更可能とする）
- **初期値**: キャラクター生成時の設定やシナリオに依存するが、基本は0またはニュートラルな値とする。

### 関係性の変化
好感度の数値によって、キャラクターとの関係性が変化します。
- **恋愛・婚姻関係**: 好感度が一定の閾値を超えた場合、恋愛関係や婚姻関係を結ぶことが可能となる。
- **性別による制限なし**: 同性同士であっても、好感度が条件を満たせば問題なく恋愛・婚姻関係を結べる（LGBTQ+配慮）。

## AIによる変動判定

好感度の変動は、固定ルールではなくAIによる動的な判定を行う。

### 判定プロセス
AIは以下の情報を入力として、好感度の変動値を決定する。
1. **キャラクターデータ**: 性格、価値観、現在の好感度、隠しステータス（後述）。
2. **プレイヤーの入力**: 会話内容、行動（Action）。
3. **NPCの応答**: プレイヤーの行動に対するNPCの反応。

### 判定基準
- **上昇**: キャラクターが喜び、感謝し、または好意的な感情を抱く行動・会話。
- **下降**: キャラクターが嫌悪感を示し、怒り、または不快に感じる行動・会話。
- **変化なし（ニュートラル）**: 日常的な会話や、特に感情を動かさない行動。
    - **重要**: AIは「何でもかんでも上昇」させないこと。文脈に意味がない、あるいは単なる作業的な行動に対しては0を返す判断も許容する。

## キャラクターステータス拡張

### 隠しステータス
キャラクターの属性として、以下の隠しステータスの導入を許可する。これらは好感度やNSFWの閾値判定に影響を与える。
- **性格 (Personality)**: 開放的、保守的、好奇心旺盛など。
- **恋愛経験 (Romantic Experience)**: 経験人数や過去の恋愛の深度。

## NSFW（成人向け）要素の制限緩和

### 基本ルール
- NSFWに抵触するような親密な行為は、原則として好感度が高くなければ許可されない。

### 例外条件
キャラクターの隠しステータス等によって、閾値は変動可能とする。
- **年齢・経験**: 年齢が高い、あるいは恋愛経験が豊富なキャラクターは、閾値が低く設定される場合がある。
- **性格**: 開放的な性格のキャラクターも同様に閾値を緩和してよい。

## アイテム・プレゼント

### 制約事項
- プレゼント機能の実装は現段階では行わない（将来的な実装）。
- **インベントリ制限**: プレゼントを行う場合、対象となるアイテムはプレイヤーの**インベントリに実際に存在するもの**でなければならない。架空のアイテムを生成してプレゼントすることは不可とする。

## 実装詳細（Implementation Details）

### アーキテクチャ構成
好感度の変動処理は、チャット生成プロセスにおける「事後処理（Post-Processing）」として実装する。これにより、NPCの実際の応答内容を加味した、より精度の高い判定が可能となる。

### 処理フロー
1.  **ユーザー入力処理（Phase 1-2）**
    -   ユーザーのメッセージを受け取り、行動解析（Action Analysis）を行う（既存実装）。
2.  **応答生成（Phase 3）**
    -   Main Model（高負荷・高知能）を使用して、NPCのセリフと行動を生成する。
    -   **理由**: キャラクター性を色濃く反映した創造的な文章が必要なため、高性能モデルを使用。
3.  **好感度判定（Phase 4: New）**
    -   **タイミング**: NPCの応答が生成され、確定した後。
    -   **使用モデル**: Sub Model（低負荷・高速）。
    -   **入力情報**:
        -   ユーザーの入力（Original Input）
        -   解析されたユーザーの意図（Action Analysis Result）
        -   **NPCの実際の応答（NPC Response）**
        -   現在の好感度とキャラクター性格
    -   **出力情報（JSON）**:
        -   `affection_delta`: 変動値（例: -10, 0, +5）。ニュートラル(0)を推奨。
        -   `reason`: 変動の理由（デバッグ・ログ用）。
    -   **処理内容**:
        -   `affection_delta` を現在の好感度に加算し、DB（EntityEnvironment）を更新する。
        -   変動があった場合、クライアントに通知（任意）。

### LLMの使い分け
| 処理フェーズ | 推奨モデル | 理由 |
| :--- | :--- | :--- |
| **Action Analysis** (意図解析) | **Sub Model** (Low-Load & Fast) | 論理的な分類タスクであり、創造性よりも処理速度とJSON形式の遵守が求められるため。 |
| **Response Generation** (会話生成) | **Main Model** (High-Load & Creative) | ユーザー体験の核心であり、深い文脈理解と豊かな表現力（キャラクター性）が必要なため。 |
| **Affection Judgment** (好感度判定) | **Sub Model** (Low-Load & Fast) | 既存のテキスト（入力と応答）に基づく分析・採点タスクであり、ハイスペックな推論能力は過剰であるため。 |

## 開発上の留意点
- ブランチ運用: 機能実装や仕様変更は `feature/XXX` 形式のブランチで行うこと。
